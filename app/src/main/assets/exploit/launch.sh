#!/bin/sh
# kudos to https://github.com/zhuowei/cheese-app/blob/c7a34c75af85d6bae712536b71a1ece0f2a6457d/app/src/main/assets/cheese/launch.sh
#echo "mod by @a62family (tg)"
#echo "launch.sh running"
#echo "got root, doing magic fixes..."
#cd "$(dirname "$0")"
#umask 000
#export FIRST_STAGE=1
#export ASH_STANDALONE=1
#PATH="/product/bin:/apex/com.android.runtime/bin:/apex/com.android.art/bin:/system_ext/bin:/system/bin:/system/xbin:/odm/bin:/vendor/bin:/vendor/xbin"
#export PATH
#echo "starting magisk setup... (may take a while, don't touch anything)"
#echo "if you see /debug_ramdisk errors, use manual for magisk install (write soon)"
#sh "$PWD/live_setup.sh"
#!/system/bin/sh

# === АВТО-ПЕРЕЗАПУСК ЧЕРЕЗ WRAPPER (один раз) ===
if [ "$WRAPPER_DONE" != "1" ] && [ -x "$(dirname "$0")/wrapper" ]; then
    export WRAPPER_DONE=1
    exec "$(dirname "$0")/wrapper" "$0" "$@"
fi

# === ПРОДОЛЖАЕМ РАБОТУ БЕЗ ПРОВЕРКИ КОНТЕКСТА ===
# (seccomp всё равно блокирует setcon, но root UID позволяет делать mount)
echo "mod by @a62family (tg)"
echo "launch.sh running, context: $(cat /proc/self/attr/current)"

cd "$(dirname "$0")"
umask 000
export FIRST_STAGE=1
export ASH_STANDALONE=1

# === СОЗДАЁМ РАБОЧУЮ ДИРЕКТОРИЮ (вместо /debug_ramdisk) ===
export MAGISKTMP="$(pwd)/magisk_work"
mkdir -p "$MAGISKTMP"

# Пытаемся примонтировать tmpfs (работает с root UID даже в shell контексте)
mount -t tmpfs -o mode=0755 tmpfs "$MAGISKTMP" 2>/dev/null
if [ $? -eq 0 ]; then
    echo "✓ tmpfs смонтирован в $MAGISKTMP"
else
    echo "⚠️  tmpfs не смонтирован, используем просто директорию"
fi

echo "starting magisk setup..."
sh "$PWD/live_setup.sh"