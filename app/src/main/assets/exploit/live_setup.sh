#####################################################################
#   AVD Magisk Setup
#####################################################################
#
# Support API level: 23 - 35
#
# For developing Magisk, just use:
# ./build.py emulator
#
# This script will stop zygote, simulate the Magisk start up process
# that would've happened before zygote was started, and finally
# restart zygote. This is useful for setting up the emulator for
# developing Magisk, testing modules, and developing root apps using
# the official Android emulator (AVD) instead of a real device.
#
# This only covers the "core" features of Magisk. For testing
# magiskinit, please checkout avd_patch.sh.
#
#####################################################################
echo "live_setup.sh running"
if [ "$(cat /proc/self/attr/current)" != "u:r:init:s0" ]; then
    echo "FATAL: Wrong context!"
    exit 1
fi
mount_tmpfs() {
  # If a file name 'magisk' is in current directory, mount will fail
  mv magisk magisk.tmp
  mount -t tmpfs -o 'mode=0755' magisk $1
  mv magisk.tmp magisk
}

mount_sbin() {
  mount_tmpfs /sbin
  chcon u:object_r:rootfs:s0 /sbin
}

if [ ! -f /system/build.prop ]; then
  # Running on PC
  echo 'Please run `./build.py emulator` instead of directly executing the script!'
  exit 1
fi

# cheese: attempt to protect boot
mv /dev/block/by-name/boot_a /dev/block/by-name/DO_NOT_FLASH_boot_a
mv /dev/block/by-name/boot_b /dev/block/by-name/DO_NOT_FLASH_boot_b
ln -s /dev/does/not/exist_a /dev/block/by-name/boot_a
ln -s /dev/does/not/exist_b /dev/block/by-name/boot_b

# cheese: different directory
cd "$(dirname "$0")"
#cd /data/local/tmp
#chmod 755 busybox

if [ -z "$FIRST_STAGE" ]; then
  export FIRST_STAGE=1
  export ASH_STANDALONE=1
  if [ $(./busybox id -u) -ne 0 ]; then
    # Re-exec script with root
    exec /system/xbin/su 0 /data/local/tmp/busybox sh $0
  else
    # Re-exec script with busybox
    exec ./busybox sh $0
  fi
fi

# checking for old magisk app.
if pm path com.topjohnwu.magisk; then
  echo "uninstalling old magisk apk"
  pm uninstall com.topjohnwu.magisk
fi

MAX_ATTEMPTS=3
ATTEMPT=1
INSTALLED=false

echo "Checking for Magisk installation/update..."

APK_PATH="$(pwd)/magisk.apk"
INSTALLED=false
NEED_INSTALL=false

if pm path com.veygax.eventhorizon.magisk >/dev/null 2>&1; then
    echo "Magisk currently installed. Checking details..."

    PKG_INFO=$(dumpsys package com.veygax.eventhorizon.magisk 2>/dev/null)
    INSTALLED_VER=$(echo "$PKG_INFO" | grep versionCode | head -n1 | awk -F= '{print $2}' | awk '{print $1}')
    INSTALLED_SIG=$(echo "$PKG_INFO" | grep "signatures=" | grep -o "signatures:\[[0-9a-f]*\]" | awk -F'[][]' '{print $2}')

    echo "Installed Magisk versionCode: $INSTALLED_VER"
    echo "Bundled Magisk versionCode:  $BUNDLED_VER"
    echo "Installed signature: $INSTALLED_SIG"
    echo "Expected signature:  b52d5ff"

    if [ "$INSTALLED_SIG" != "b52d5ff" ]; then
        echo "Signature mismatch! Uninstalling old Magisk..."
        pm uninstall com.veygax.eventhorizon.magisk >/dev/null 2>&1
        NEED_INSTALL=true
    elif [ "$BUNDLED_VER" -gt "$INSTALLED_VER" ]; then
        echo "Same signature, newer version found. Updating in place..."
        pm install -r -g "$APK_PATH"
        if pm path com.veygax.eventhorizon.magisk >/dev/null 2>&1; then
            echo "Magisk updated successfully."
            INSTALLED=true
        fi
    else
        echo "Magisk is up-to-date. Skipping reinstall."
        INSTALLED=true
    fi
else
    echo "Magisk not installed. Will install."
    NEED_INSTALL=true
fi

if $NEED_INSTALL; then
    ATTEMPT=1
    while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
        echo "Installing Magisk (Attempt $ATTEMPT/$MAX_ATTEMPTS)..."
        pm install -g "$APK_PATH"
        if pm path com.veygax.eventhorizon.magisk >/dev/null 2>&1; then
            echo "Magisk installed successfully."
            INSTALLED=true
            break
        else
            echo "Installation failed. Retrying in 5 seconds..."
            ATTEMPT=$((ATTEMPT + 1))
            sleep 5
        fi
    done
fi

if ! $INSTALLED; then
    echo "FATAL: Could not install Magisk after $MAX_ATTEMPTS attempts. Aborting setup."
    exit 1
fi

# After checking or attempting installation, fail if it's still not present
if ! $INSTALLED; then
    echo "FATAL: Could not install Magisk after $MAX_ATTEMPTS attempts. Aborting setup."
    exit 1
fi

# Extract files from APK
unzip -oj magisk.apk 'assets/util_functions.sh' 'assets/stub.apk'
. ./util_functions.sh

api_level_arch_detect

unzip -oj magisk.apk "lib/$ABI/*" -x "lib/$ABI/libbusybox.so"
for file in lib*.so; do
  chmod 755 $file
  mv "$file" "${file:3:${#file}-6}"
done

if $IS64BIT && [ -e "/system/bin/linker" ]; then
  unzip -oj magisk.apk "lib/$ABI32/libmagisk.so"
  mv libmagisk.so magisk32
  chmod 755 magisk32
fi

# Stop zygote (and previous setup if exists)
magisk --stop 2>/dev/null
# cheese: cheese doesn't patch SELinux properly, so needs init context here...
# stop
# runcon u:r:init:s0 stop
# line 160 = crash
if [ -d /debug_ramdisk ]; then
  umount -l /debug_ramdisk 2>/dev/null
fi

# Make sure boot completed props are not set to 1
# cheese: and here...
runcon u:r:init:s0 setprop sys.boot_completed 0

# Mount /cache if not already mounted
if ! grep -q ' /cache ' /proc/mounts; then
  mount -t tmpfs -o 'mode=0755' tmpfs /cache
fi

MAGISKTMP=/sbin

# Setup bin overlay
if mount | grep -q rootfs; then
  # Legacy rootfs
  mount -o rw,remount /
  rm -rf /root
  mkdir /root /sbin 2>/dev/null
  chmod 750 /root /sbin
  ln /sbin/* /root
  mount -o ro,remount /
  mount_sbin
  ln -s /root/* /sbin
elif [ -e /sbin ]; then
  # Legacy SAR
  mount_sbin
  mkdir -p /dev/sysroot
  block=$(mount | grep ' / ' | awk '{ print $1 }')
  [ $block = "/dev/root" ] && block=/dev/block/vda1
  mount -o ro $block /dev/sysroot
  for file in /dev/sysroot/sbin/*; do
    [ ! -e $file ] && break
    if [ -L $file ]; then
      cp -af $file /sbin
    else
      sfile=/sbin/$(basename $file)
      touch $sfile
      mount -o bind $file $sfile
    fi
  done
  umount -l /dev/sysroot
  rm -rf /dev/sysroot
else
  # Android Q+ without sbin
  if [ -z "$MAGISKTMP" ]; then
    MAGISKTMP="$(dirname "$0")/magisk_work"
    mkdir -p "$MAGISKTMP"
  fi
  mount_tmpfs "$MAGISKTMP"
fi

# Magisk stuff
mkdir -p $MAGISKBIN 2>/dev/null
unzip -oj magisk.apk 'assets/*.sh' -d $MAGISKBIN
mkdir /data/adb/modules 2>/dev/null
mkdir /data/adb/post-fs-data.d 2>/dev/null
mkdir /data/adb/service.d 2>/dev/null

for file in magisk magisk32 magiskpolicy stub.apk; do
  chmod 755 ./$file
  cp -af ./$file $MAGISKTMP/$file
  cp -af ./$file $MAGISKBIN/$file
done
cp -af ./magiskboot $MAGISKBIN/magiskboot
cp -af ./magiskinit $MAGISKBIN/magiskinit
cp -af ./busybox $MAGISKBIN/busybox

ln -s ./magisk $MAGISKTMP/su
ln -s ./magisk $MAGISKTMP/resetprop
ln -s ./magiskpolicy $MAGISKTMP/supolicy

mkdir -p $MAGISKTMP/.magisk/device
mkdir -p $MAGISKTMP/.magisk/worker
mount_tmpfs $MAGISKTMP/.magisk/worker
mount --make-private $MAGISKTMP/.magisk/worker
touch $MAGISKTMP/.magisk/config

export MAGISKTMP
MAKEDEV=1 $MAGISKTMP/magisk --preinit-device 2>&1

RULESCMD=""
rule="$MAGISKTMP/.magisk/preinit/sepolicy.rule"
[ -f "$rule" ] && RULESCMD="--apply $rule"

# SELinux stuffs
if [ -d /sys/fs/selinux ]; then
  if [ -f /vendor/etc/selinux/precompiled_sepolicy ]; then
    ./magiskpolicy --load /vendor/etc/selinux/precompiled_sepolicy --live --magisk $RULESCMD 2>&1
  elif [ -f /sepolicy ]; then
    ./magiskpolicy --load /sepolicy --live --magisk $RULESCMD 2>&1
  else
    ./magiskpolicy --live --magisk $RULESCMD 2>&1
  fi
fi

# Boot up
$MAGISKTMP/magisk --post-fs-data
start
$MAGISKTMP/magisk --service
# Make sure reset nb prop after zygote starts
sleep 2
$MAGISKTMP/magisk --boot-complete